# Дизайн ML системы - Оптимизация А/Б тестирования с помощью машинного обучения

## 1. Цели и предпосылки

### 1.1. Зачем идем в разработку продукта?

Сегодня А/Б тестирование - это основной метод научного доказательства влияния изменений в продукте на метрики, который повсеместно используется. Тем не менее, А/Б тестирование часто либо невозможно, либо недостаточно данных для проведения теста, либо для достижения заданного уровня значимости и мощности тест длится слишком долго. Таким образом, цели данного проекта:
1. Улучшение скорости проведения A/B тестов и уменьшение дисперсии теста с использованием машинного обучения.
2. Решение проблемы малых выборок, а также проведение аналогов A/B тестов там, где разбиение на группы невозможно (с использованием CUPAC и прогнозирования).
3. Повышение шансов обнаружения гипотез, которые улучшат целевые метрики и приведут к увеличению прибыли. Экономия времени, затрачиваемого на тесты, может быть перераспределена на другие задачи, способствуя росту прибыли.

- **Бизнес-цель:** С помощью машинного обучения можно уменьшить дисперсию теста, тем самым ускоряя его и решить проблему маленьких выборок, а также провести аналог A/B теста там, где разбиение на группы невозможно (CUPAC и прогнозирование). Ускоряя тесты, мы помогаем бизнесу проводить больше тестов, а чем больше тестов мы можем провести, тем больше шанс найти гипотезы, которые улучшат целевые метрики и приведут к росту прибыли. А потенциальная экономия времени, которое тратится на тесты может потратиться также и на другие задачи, что может помочь бизнесу увеличить прибыль за счет сокращения времени.
  
- **Почему станет лучше, чем сейчас, от использования ML:** Машинное обучение либо улучшает существующие методы (CUPAC) оптимизации экспериментов, либо предлагает принципиально новые методы (прогнозирование), которые невозможны без ML. Наш проект позволит ускорить скорость выполнения теста.

- **Что будем считать успехом итерации с точки зрения бизнеса:** Работающий сервис по применению ML в экспериментах, доказанная эффективность (уменьшения доверительного интервала относительно классических критериев и CUPAC) предложенных ML методах на синтетических (смоделированных) данных и доступных датасетах, готовый отчет и дизайн-док по проекту.

### 1.2. Бизнес-требования и ограничения

**Целевое решение:** Сервис по применению машинного обучения для оптимизации и проведения АБ-тестов. Сервис позволяет провести тест с использованием CUPAC или уменьшить дисперсию текущего теста для сокращения времени, необходимого для проведения тестов.

# Логика работы

1. В веб-интерфейсе пользователь выбирает, что необходимо сделать - провести тест или уменьшить дисперсию текущего теста с использованием CUPAC.
2. Загружает данные в веб-интерфейс.
3. Сервис обучает модель, подбирает гиперпараметры, рассчитывает статистические критерии.
4. Пользователю выводится результат - анализ A/B теста со всей необходимой информацией после применения ML.

## Use-Case 1: Запуск A/B теста с использованием CUPAC

**Участники:** Аналитик, менеджер по продукту, разработчик.

**Цель:** Запустить A/B тест для оценки влияния изменений в продукте на ключевые метрики, используя CUPAC для контрольной группы.

**Основные шаги:**

1. Аналитик входит в веб-интерфейс сервиса и выбирает опцию "Создать новый A/B тест".
2. Загружает необходимые данные о тесте, включая характеристики пользователей и метрики, которые требуется оценить.
3. Сервис обучает модель машинного обучения на основе предоставленных данных и применяет CUPAC для контрольной группы.
4. Аналитик настраивает параметры теста, такие как уровень значимости и длительность теста.
5. Модель машинного обучения проводит анализ результатов теста и предоставляет выводы, включая оценку влияния изменений на метрики и уровень статистической значимости.
6. Аналитик и менеджер по продукту анализируют результаты и принимают решение о дальнейших шагах на основе данных от сервиса.

## Бизнес-ограничения

- Сервис на первой итерации работает с поюзерными тестами с непрерывными целевыми метриками.
- Уменьшение дисперсии зависит от предсказательной силы модели для данных пользователя и не всегда будет приводить к существенному сокращению дисперсии.
- Не предполагает использования для A/B/C/n тестирования.
- Модель должна отрабатывать за ограниченное кол-во времени (не дольше 10 минут).
- Первоначально модель должна быть расчитана на максимальную нагрузку 10 запросов в минуту.
- Данные для загрузки в сервис должны быть строго по формату.

## Критерии успеха

- Доказанная эффективность (уменьшения доверительного интервала относительно классических критериев и CUPED) предложенных ML методах на синтетических (смоделированных) данных и доступных датасетах.
- Обучение моделей и подсчет статистических критериев для тестов происходит в соответствии с установленными ограничениями по времени и нагрузке.
- Веб-интерфейс обеспечивает удобную загрузку данных и предоставляет пользователю полный анализ результатов A/B тестирования, включая статистические выводы.
- Система должна быть легко масштабируемой для обеспечения возможности добавления новых пользователей и увеличения нагрузки без существенных изменений в архитектуре

### 1.3. Что входит в скоуп проекта/итерации, что не входит

- **На закрытие каких БТ подписываемся в данной итерации:** реализация веб-интерфейса, мл-составляющая, аналитическая составляющая, визуализация.
  
- **Результат с точки зрения качества кода и воспроизводимости решения:** Отдельный репозиторий с приложением streamlit и fast-api. Используется модульный подход, где каждый модуль отвечает за свою часть – предобработка данных, моделирование, визуализация и т.д.
  
- **Описание планируемого технического долга (что оставляем для дальнейшей продуктивизации):** Добавить логирование, авторизацию пользователей, потоковая обработка данных с экспериментов, отдельное API с реализованными методами.


### 1.4. Предпосылки решения

- Существующие методы A/B тестирования известны, но их применение с использованием машинного обучения требует глубокой экспертизы, что может оказаться сложным для компаний без специализированных знаний.
- Отсутствие прозрачной и доступной реализации, которая бы позволила компаниям получать качественные результаты с применением машинного обучения без необходимости в глубоких технических знаниях в данной области.
- Согласованность с бизнес-процессами компаний, так как внедрение новых методов A/B тестирования и инфраструктуры может потребовать изменений в существующих процессах, что влечет за собой дополнительные траты и нагрузку для компании.
- Наличие доступных и качественных данных для проведения A/B тестирования, а также для обучения моделей машинного обучения, включая исторические данные по экспериментам.
- Возможность применения CUPAC (Controlled Univariate Predictive Analytics for Causal inference) для проведения более точных и эффективных A/B тестов, снижения дисперсии и улучшения обобщающей способности моделей машинного обучения.

## 1.5. Определение бизнес-метрик

Для оценки эффективности сервиса и оптимизации A/B тестов мы определяем ключевые бизнес-метрики, которые объединяются в единую формулу, измеряемую в деньгах и понятную бизнесу. Эти метрики включают:

1. **Экономия времени на A/B тестах:** Мы измеряем и сравниваем время, затрачиваемое на проведение A/B тестов до и после внедрения сервиса. Экономия времени выражается в количестве дней, которые мы экономим благодаря оптимизации A/B тестов.

2. **Экономия в денежном эквиваленте:** Мы вычисляем экономию времени в денежных терминах, учитывая затраты на зарплаты сотрудников, занятых проведением A/B тестов. Это включает в себя оплату рабочего времени и ресурсы, затрачиваемые на тестирование.

Эти метрики объединяются в формулу, которая позволяет измерить, сколько денег компания экономит благодаря оптимизации A/B тестов. Данная формула учитывает как время, так и деньги, и помогает бизнесу оценить влияние оптимизации на финансовые результаты.

#### Формула

Для расчета экономии времени и денег на A/B тестах, можно использовать следующую формулу:

Cost Savings = (Time Savings * Hourly Wage) + Additional Expenses

Где:

- **Time Savings**: количество дней, которое компания экономит благодаря оптимизации A/B тестов.
- **Hourly Wage**: средняя зарплата сотрудника, занятого проведением A/B тестов, выраженная в часах работы.
- **Additional Expenses**: любые другие затраты, связанные с проведением тестов (например, стоимость инструментов и ресурсов).

This formula allows you to assess the financial benefit of optimizing A/B tests in your company.



## 2. Методология 

### 2.1. Постановка задачи

Аналитическая и ML часть проекта будут состоять из следующих компонент:

- Увеличение чувствительности тестов с помощью ML - реализация CUPED, CUPAC, CUNOPAC, автоматизация обучения модели и выбор наиболее подходящего метода сокращения дисперсии.
- Проведение тестов без возможности разделения на тест и контроль - применение CUPAC для анализа результатов A/B тестов.

### 2.2. Блок-схема решения

![Scheme.png](Scheme.png)

### 2.3. Этапы решения задачи 

1. **Подготовка данных и моделирование синтетических данных:**
   - Сбор и подготовка данных, включая исторические результаты A/B тестов и характеристики пользователей.
   - Разработка скриптов и моделей для создания контрольных групп.

2. **Разработка и обучение моделей машинного обучения:**
   - Выбор и настройка алгоритмов машинного обучения для оптимизации A/B тестов.
   - Разработка моделей для прогнозирования метрик в синтетических контрольных группах.
   - Реализация автоматизации обучения и подбора гиперпараметров моделей.

3. **Анализ A/B тестов и статистическая обработка данных:**
   - Реализация аналитической составляющей, включая расчет p-value, доверительных интервалов и статистических критериев.
   - Подготовка инференса моделей и расчета аналитики для результатов тестов.

4. **Разработка веб-интерфейса и интеграция:**
   - Разработка веб-интерфейса для загрузки данных и настройки A/B тестов.
   - Интеграция разработанных моделей машинного обучения и аналитических инструментов в веб-сервис.

5. **Визуализация результатов:**
   - Разработка визуализации результатов A/B тестов в веб-интерфейсе для удобного анализа пользователями.

6. **Тестирование:**
   - Проведение функционального тестирования для проверки правильности работы всех компонентов системы.
   - Проведение нагрузочного тестирования для оценки производительности системы под нагрузкой.

7. **Подготовка финального отчета:**
   - Подготовка подробного отчета о проделанной работе, методологии и результатов, доступного для пользователей.

## 3. Подготовка пилота

### 3.1. Способ оценки пилота
Для оценки успешности пилота будут использованы следующие метрики и процедуры:

Уровень значимости и статистическая мощность: 
- Мы оценим, насколько пилотные A/B тесты, проведенные с применением машинного обучения, способны обнаруживать статистически значимые различия между контрольной и тестовой группами. Успешным считается пилот, если достигнуты заранее установленные уровни значимости и мощности.

- Скорость выполнения тестов: Мы сравним время, необходимое для проведения A/B тестов с использованием машинного обучения и без него. Успешным пилотом будет считаться, если сокращение времени будет достаточно значительным.

- Оценка экономической эффективности: Мы оценим экономическую пользу от сокращения времени, затрачиваемого на тестирование, и увеличение количества тестов. Если пилот позволит снизить издержки и/или увеличить прибыль, он будет признан успешным.

## Выбор метрик

**Выбор правильных метрик для оценки производительности нашей системы оптимизации A/B-тестов имеет решающее значение. Наш выбор показателей должен соответствовать целям и задачам проекта. Вот ключевые показатели, которые мы будем использовать для оценки:**

## Выбор метрик

**Выбор правильных метрик для оценки производительности нашей системы оптимизации A/B-тестов имеет решающее значение. Наш выбор показателей должен соответствовать целям и задачам проекта. Вот ключевые показатели, которые мы будем использовать для оценки:**

### 1. Показатель уменьшения рассеивания

- **Описание показателя:** Этот показатель оценивает снижение дисперсии, достигнутое за счет оптимизации A/B-теста.
- **Зависимости:** Это зависит от характеристик данных и варьируется для наборов данных с разным уровнем шума.
- **Предпочтительный показатель:** Мы будем использовать среднюю абсолютную процентную ошибку (MAPE) в качестве подходящего показателя. Максимально допустимый уровень MAPE составляет 30-40%.
- **Процесс измерения:** Мы проведем A/B тесты, выделив временной интервал для уменьшения шума и получения выводов (сигнала).
- **Значимость:** Этот показатель помогает нам понять, как наш метод влияет на A / B-тесты, сравнивая результаты до и после внедрения нашего метода.
- **Требования к данным:** Мы рассмотрим период времени для сбора данных не менее одного месяца.

### 2. Показатель повышения чувствительности

- **Описание показателя:** Этот показатель измеряет среднее процентное увеличение чувствительности.
- **Зависимости:** Это зависит от данных и этапов предварительной обработки.
- **Предпочтительный показатель:** В качестве показателя мы будем использовать процентное увеличение чувствительности.
- **Процесс измерения:** Мы сравним A /B тесты с использованием нашего метода и без него.
- **Значимость:** Этот показатель помогает нам понять разницу в A/B тестах при применении нашего метода по сравнению с A/B тестами без нашего метода.
- **Требования к данным:** Мы будем использовать данные, собранные по крайней мере за предыдущий месяц, охватывающие более длительный период.

### 3. Автономные показатели

- **Описание показателя:** Эти показатели оценивают производительность системы оптимизации A/B-тестов на основе исторических данных и фактических результатов.
- **Предпочтительные показатели:** Мы рассмотрим отзывчивость и специфичность. Наш целевой показатель - отзыв при специфичности > 99,85%.
- **Процесс измерения:** Эти показатели помогают нам оценить влияние нашего метода на бизнес-показатели.
- **Значимость:** Мы стремимся сократить потери от неэффективных A/B-тестов и улучшить пользовательский опыт.
- **Требования к данным:** Исторические данные будут использоваться для обучения и оценки.

### 4. Онлайн-показатели

- **Описание показателя:** Эти показатели дают представление о производительности нашей системы оптимизации A/B-тестов в режиме реального времени.
- **Предпочтительные показатели:** Мы будем использовать косвенные показатели, такие как количество жалоб, для оценки онлайн-производительности.
- **Процесс измерения:** Эти показатели ценны для проведения A/B-тестов и оценки результатов в реальном времени.
- **Значимость:** Онлайн-показатели позволяют нам оценивать производительность нашей системы непосредственно при работе.
- **Требования к данным:** Будут использоваться данные о текущих A/B-тестах.

### 5. Технические показатели

- **Описание показателя:** Технические показатели связаны с производительностью и скоростью работы нашей системы оптимизации A/B-тестов.
- **Предпочтительные показатели:** Некоторые примеры включают скорость обработки тестовых данных и отзывчивость системы.
- **Процесс измерения:** Эти показатели гарантируют эффективную работу нашей системы.
- **Значимость:** Технические показатели помогают оценить производительность системы оптимизации A/B-тестов.
- **Требования к данным:** Будут собраны данные, относящиеся к производительности системы.

**Выбор этих показателей позволяет нам оценить эффективность нашей системы оптимизации A/B-тестов с различных точек зрения, включая бизнес-показатели, точность обнаружения и производительность системы. Такой комплексный подход гарантирует, что мы сможем принимать обоснованные решения и приводить нашу систему в соответствие с требованиями проекта и бизнес-целями.**



### 3.2. Что считаем успешным пилотом
Пилот будет считаться успешным, если выполняются следующие условия:

Удалось достичь уровней значимости и мощности, позволяющих надежно обнаруживать статистически значимые различия в A/B тестах.

Время, затрачиваемое на проведение A/B тестов, было существенно сокращено по сравнению с предыдущими методами.

Обнаружена экономическая выгода от применения машинного обучения в A/B тестировании, такая как увеличение количества проведенных тестов, увеличение прибыли или снижение издержек.

### 3.3. Подготовка пилота


## 4. Внедрение 

### 4.1. Архитектура решения

Архитектура решения будет включать в себя следующие компоненты:

Веб-интерфейс: Пользователи будут иметь доступ к веб-интерфейсу для загрузки данных и настройки A/B тестов.

Модели машинного обучения: Модели для оптимизации A/B тестов и прогнозирования результатов будут развернуты в сервисе.

Службы автоматизации: Сервис будет включать компоненты для автоматической настройки моделей и расчета статистических критериев.

### 4.2. Описание инфраструктуры и масштабируемости

### 4.3. Требования к работе системы

- **Пропускная способность и задержка обеспечивается структурой и возможностью масштабирования**
### 4.4. Безопасность системы

### 4.5. Безопасность данных

### 4.6. Издержки

### 4.5. Integration points

### 4.6. Риски